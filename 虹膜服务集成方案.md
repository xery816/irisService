# 虹膜识别服务集成方案

## 一、系统架构

```
┌────────────────────── 客户端 Linux 终端 ──────────────────────┐
│                                                               │
│   ┌──────────────┐         ┌──────────────────────────────┐  │
│   │   浏览器      │  HTTP   │        虹膜服务               │  │
│   │  (React)     │◄───────►│    http://localhost:5000     │  │
│   │              │         │                              │  │
│   │  - 视频显示   │         │  - /api/video/stream (视频流) │  │
│   │  - 注册界面   │         │  - /api/register/* (注册)     │  │
│   │  - 识别界面   │         │  - /api/recognize (识别)      │  │
│   └──────────────┘         └──────────────┬───────────────┘  │
│                                           │                   │
│                                           │ USB               │
│                                           ▼                   │
│                                    ┌─────────────┐            │
│                                    │  红外摄像头  │            │
│                                    └─────────────┘            │
└───────────────────────────────────────────────────────────────┘
```

**说明**：
- React 前端直连虹膜服务，**Spring Boot 无需任何改动**
- 使用 HTTP API + MJPEG 视频流，简单可靠
- 生产环境：前端和虹膜服务部署在同一台客户端机器

---

## 二、测试环境配置

测试时前端在本地开发机，虹膜服务在 Linux 机器：

```
┌─────────────────┐          ┌─────────────────┐
│  本地开发机      │   网络    │   Linux 机器     │
│  (Windows)      │◄────────►│                 │
│                 │          │  虹膜服务        │
│  浏览器 (React) │          │  192.168.x.x    │
│                 │          │  :5000          │
└─────────────────┘          └────────┬────────┘
                                      │ USB
                                      ▼
                               ┌─────────────┐
                               │  红外摄像头  │
                               └─────────────┘
```

**前端配置**：

```tsx
// 使用环境变量切换地址
const IRIS_URL = process.env.REACT_APP_IRIS_URL || 'http://localhost:5000';

// 测试环境 .env.development
REACT_APP_IRIS_URL=http://192.168.1.100:5000

// 生产环境 .env.production
REACT_APP_IRIS_URL=http://localhost:5000
```

---

## 三、虹膜服务 API

### 3.1 接口列表

| 端点 | 方法 | 说明 |
|------|------|------|
| `/api/status` | GET | 获取服务状态和检测结果 |
| `/api/video/stream` | GET | MJPEG 视频流（带双圆检测框） |
| `/api/register/capture` | POST | 采集一张虹膜样本 |
| `/api/register/complete` | POST | 完成注册，生成特征 |
| `/api/recognize` | POST | 虹膜识别 |

### 3.2 接口详情

#### 获取状态
```http
GET /api/status

Response:
{
  "running": true,
  "iris_detected": true,
  "detection": {
    "detected": true,
    "inner": [320, 240, 45],
    "outer": [318, 238, 120]
  }
}
```

#### 视频流
```http
GET /api/video/stream

Response: MJPEG 视频流 (multipart/x-mixed-replace)
- 自动绘制双圆检测框（内圆=瞳孔，外圆=虹膜边界）
- 帧率约 30fps
```

#### 采集虹膜样本
```http
POST /api/register/capture
Content-Type: application/json

Body:
{
  "user_id": "zhangsan",
  "eye": "L"  // L=左眼, R=右眼
}

Response:
{
  "success": true,
  "path": "photo/zhangsan/L/1733312345_L_1.jpeg",
  "eye": "L",
  "index": 1
}
```

#### 完成注册
```http
POST /api/register/complete
Content-Type: application/json

Body:
{
  "user_id": "zhangsan"
}

Response:
{
  "success": true
}
```

#### 虹膜识别
```http
POST /api/recognize

Response:
{
  "success": true,
  "user_id": "zhangsan",
  "eye": "L",
  "confidence": 85.5,
  "score": 14500
}
```

---

## 四、虹膜服务代码

### 4.1 主服务文件 `iris_service.py`

```python
# -*- coding: utf-8 -*-
"""
虹膜识别 HTTP 服务
启动命令: python iris_service.py --host 0.0.0.0 --port 5000 --camera 0
"""

from flask import Flask, Response, jsonify, request
from flask_cors import CORS
import cv2
import threading
import time
import os
import numpy as np

app = Flask(__name__)
CORS(app, origins="*")


class IrisService:
    def __init__(self, camera_index=0):
        self.camera_index = camera_index
        self.cap = None
        self.is_running = False
        self.current_frame = None
        self.is_iris_detected = False
        self.detection_result = {'detected': False}
        self.lock = threading.Lock()

    def start_camera(self):
        """启动红外摄像头"""
        if self.cap is None or not self.cap.isOpened():
            self.cap = cv2.VideoCapture(self.camera_index)
            self.cap.set(cv2.CAP_PROP_FRAME_WIDTH, 1920)
            self.cap.set(cv2.CAP_PROP_FRAME_HEIGHT, 1080)
        self.is_running = True
        threading.Thread(target=self._capture_loop, daemon=True).start()
        return True

    def stop_camera(self):
        """停止摄像头"""
        self.is_running = False
        if self.cap:
            self.cap.release()
            self.cap = None

    def _capture_loop(self):
        """摄像头采集循环"""
        while self.is_running:
            if self.cap and self.cap.isOpened():
                ret, frame = self.cap.read()
                if ret:
                    gray = cv2.cvtColor(frame, cv2.COLOR_BGR2GRAY)
                    with self.lock:
                        self.current_frame = gray
                    self._detect_iris(gray)
            time.sleep(0.03)

    def _detect_iris(self, frame):
        """虹膜检测"""
        try:
            from util.innerCircle import innerCircle
            from util.outerCircle import outerCircle

            inner = innerCircle(frame)
            outer = outerCircle(frame, inner)

            self.is_iris_detected = True
            self.detection_result = {
                'detected': True,
                'inner': inner.tolist(),
                'outer': outer.tolist()
            }
        except:
            self.is_iris_detected = False
            self.detection_result = {'detected': False}

    def get_video_frame(self):
        """获取带检测标记的视频帧"""
        with self.lock:
            if self.current_frame is None:
                return None
            frame = self.current_frame.copy()

        if self.is_iris_detected and self.detection_result.get('detected'):
            from util.visualization import displayCircle
            inner = self.detection_result['inner']
            outer = self.detection_result['outer']
            frame = displayCircle(frame,
                                  inner[0], inner[1], inner[2],
                                  outer[0], outer[1], outer[2])
        return frame

    def capture_sample(self, user_id, eye):
        """采集一张虹膜样本"""
        if not self.is_iris_detected:
            return {'success': False, 'error': '未检测到虹膜'}

        with self.lock:
            if self.current_frame is None:
                return {'success': False, 'error': '无法获取图像'}
            frame = self.current_frame.copy()

        user_dir = os.path.join('photo', user_id, eye)
        os.makedirs(user_dir, exist_ok=True)

        existing = len([f for f in os.listdir(user_dir) if f.endswith('.jpeg')])
        idx = existing + 1
        timestamp = int(time.time())
        filename = f'{timestamp}_{eye}_{idx}.jpeg'
        photo_path = os.path.join(user_dir, filename)

        cv2.imwrite(photo_path, frame)

        if not os.path.exists(photo_path):
            return {'success': False, 'error': '保存失败'}

        return {
            'success': True,
            'path': photo_path,
            'eye': eye,
            'index': idx
        }

    def generate_features(self, user_id=None):
        """生成特征数据集"""
        from util.feature import generateFeatureDataset
        generateFeatureDataset()
        return {'success': True}

    def recognize(self):
        """虹膜识别"""
        if not self.is_iris_detected:
            return {'success': False, 'error': '未检测到虹膜'}

        with self.lock:
            if self.current_frame is None:
                return {'success': False, 'error': '无法获取图像'}
            frame = self.current_frame.copy()

        from util.contrast import contrast
        name, eye, scores = contrast(frame)

        if name and scores:
            best_score = scores[0][1]
            confidence = max(0, 100 - (best_score / 1000))
            return {
                'success': True,
                'user_id': name,
                'eye': eye,
                'confidence': round(confidence, 2),
                'score': best_score
            }

        return {'success': False, 'error': '未找到匹配'}


# 全局服务实例
iris_service = IrisService()


# ==================== HTTP API ====================

@app.route('/api/status', methods=['GET'])
def get_status():
    """获取服务状态"""
    return jsonify({
        'running': iris_service.is_running,
        'iris_detected': iris_service.is_iris_detected,
        'detection': iris_service.detection_result
    })


@app.route('/api/video/stream')
def video_stream():
    """MJPEG 视频流"""
    def generate():
        while True:
            frame = iris_service.get_video_frame()
            if frame is not None:
                if len(frame.shape) == 2:
                    frame = cv2.cvtColor(frame, cv2.COLOR_GRAY2BGR)
                _, buffer = cv2.imencode('.jpg', frame, [cv2.IMWRITE_JPEG_QUALITY, 80])
                yield (b'--frame\r\n'
                       b'Content-Type: image/jpeg\r\n\r\n' + buffer.tobytes() + b'\r\n')
            time.sleep(0.033)

    return Response(generate(), mimetype='multipart/x-mixed-replace; boundary=frame')


@app.route('/api/register/capture', methods=['POST'])
def capture_iris():
    """采集虹膜样本"""
    data = request.json or {}
    user_id = data.get('user_id')
    eye = data.get('eye', 'L')

    if not user_id:
        return jsonify({'success': False, 'error': '缺少 user_id'})
    if eye not in ('L', 'R'):
        return jsonify({'success': False, 'error': 'eye 必须是 L 或 R'})

    result = iris_service.capture_sample(user_id, eye)
    return jsonify(result)


@app.route('/api/register/complete', methods=['POST'])
def complete_registration():
    """完成注册，生成特征"""
    data = request.json or {}
    user_id = data.get('user_id')
    result = iris_service.generate_features(user_id)
    return jsonify(result)


@app.route('/api/recognize', methods=['POST'])
def recognize_iris():
    """虹膜识别"""
    result = iris_service.recognize()
    return jsonify(result)


# ==================== 启动 ====================

if __name__ == '__main__':
    import argparse
    parser = argparse.ArgumentParser(description='虹膜识别服务')
    parser.add_argument('--host', default='0.0.0.0', help='监听地址')
    parser.add_argument('--port', type=int, default=5000, help='监听端口')
    parser.add_argument('--camera', type=int, default=0, help='摄像头索引')
    args = parser.parse_args()

    iris_service.camera_index = args.camera
    iris_service.start_camera()

    print(f'虹膜服务启动: http://{args.host}:{args.port}')
    print(f'视频流地址: http://{args.host}:{args.port}/api/video/stream')

    app.run(host=args.host, port=args.port, threaded=True)
```

### 4.2 依赖文件 `requirements.txt`

```
flask>=2.0.0
flask-cors>=3.0.0
opencv-python>=4.5.0
numpy>=1.20.0
PyWavelets>=1.1.0
Pillow>=8.0.0
```

---

## 五、React 前端代码

### 5.1 视频流组件

```tsx
// components/IrisVideo.tsx
import React from 'react';

const IRIS_URL = process.env.REACT_APP_IRIS_URL || 'http://localhost:5000';

interface Props {
  width?: number;
  height?: number;
}

export const IrisVideo: React.FC<Props> = ({ width = 640, height = 480 }) => {
  return (
    <img
      src={`${IRIS_URL}/api/video/stream`}
      alt="虹膜视频流"
      style={{
        width,
        height,
        objectFit: 'contain',
        backgroundColor: '#000',
        borderRadius: 8,
      }}
    />
  );
};
```

### 5.2 注册组件

```tsx
// components/IrisRegistration.tsx
import React, { useState } from 'react';
import { IrisVideo } from './IrisVideo';

const IRIS_URL = process.env.REACT_APP_IRIS_URL || 'http://localhost:5000';
const TARGET_PER_EYE = 5;

interface Props {
  userId: string;
  onComplete?: (success: boolean) => void;
}

export const IrisRegistration: React.FC<Props> = ({ userId, onComplete }) => {
  const [currentEye, setCurrentEye] = useState<'L' | 'R'>('L');
  const [count, setCount] = useState({ L: 0, R: 0 });
  const [loading, setLoading] = useState(false);
  const [message, setMessage] = useState('');

  const capture = async () => {
    setLoading(true);
    setMessage('');

    try {
      const res = await fetch(`${IRIS_URL}/api/register/capture`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user_id: userId, eye: currentEye }),
      });
      const data = await res.json();

      if (data.success) {
        const newCount = { ...count, [currentEye]: count[currentEye] + 1 };
        setCount(newCount);
        setMessage(`${currentEye === 'L' ? '左眼' : '右眼'} 第 ${newCount[currentEye]} 张采集成功`);

        // 检查是否切换眼睛或完成
        if (newCount[currentEye] >= TARGET_PER_EYE) {
          if (currentEye === 'L') {
            setCurrentEye('R');
            setMessage('左眼采集完成，请切换到右眼');
          } else {
            await completeRegistration();
          }
        }
      } else {
        setMessage(`采集失败: ${data.error}`);
      }
    } catch (e) {
      setMessage('网络错误');
    } finally {
      setLoading(false);
    }
  };

  const completeRegistration = async () => {
    setMessage('正在生成特征...');
    try {
      const res = await fetch(`${IRIS_URL}/api/register/complete`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user_id: userId }),
      });
      const data = await res.json();
      setMessage(data.success ? '注册完成！' : '特征生成失败');
      onComplete?.(data.success);
    } catch {
      setMessage('网络错误');
      onComplete?.(false);
    }
  };

  return (
    <div style={{ textAlign: 'center' }}>
      <h3>虹膜注册 - {userId}</h3>

      <IrisVideo />

      <div style={{ margin: '16px 0' }}>
        <span>左眼: {count.L}/{TARGET_PER_EYE}</span>
        <span style={{ margin: '0 16px' }}>|</span>
        <span>右眼: {count.R}/{TARGET_PER_EYE}</span>
        <span style={{ margin: '0 16px' }}>|</span>
        <strong>当前: {currentEye === 'L' ? '左眼' : '右眼'}</strong>
      </div>

      <button onClick={capture} disabled={loading} style={{ padding: '8px 24px', fontSize: 16 }}>
        {loading ? '采集中...' : '采集'}
      </button>

      {message && <p style={{ marginTop: 16, color: message.includes('失败') ? 'red' : 'green' }}>{message}</p>}
    </div>
  );
};
```

### 5.3 识别组件

```tsx
// components/IrisRecognition.tsx
import React, { useState } from 'react';
import { IrisVideo } from './IrisVideo';

const IRIS_URL = process.env.REACT_APP_IRIS_URL || 'http://localhost:5000';

interface RecognitionResult {
  success: boolean;
  user_id?: string;
  eye?: string;
  confidence?: number;
  error?: string;
}

interface Props {
  onRecognized?: (result: RecognitionResult) => void;
}

export const IrisRecognition: React.FC<Props> = ({ onRecognized }) => {
  const [loading, setLoading] = useState(false);
  const [result, setResult] = useState<RecognitionResult | null>(null);

  const recognize = async () => {
    setLoading(true);
    setResult(null);

    try {
      const res = await fetch(`${IRIS_URL}/api/recognize`, { method: 'POST' });
      const data: RecognitionResult = await res.json();
      setResult(data);
      onRecognized?.(data);
    } catch {
      setResult({ success: false, error: '网络错误' });
    } finally {
      setLoading(false);
    }
  };

  return (
    <div style={{ textAlign: 'center' }}>
      <h3>虹膜识别</h3>

      <IrisVideo />

      <div style={{ margin: '16px 0' }}>
        <button onClick={recognize} disabled={loading} style={{ padding: '8px 24px', fontSize: 16 }}>
          {loading ? '识别中...' : '开始识别'}
        </button>
      </div>

      {result && (
        <div style={{
          padding: 16,
          borderRadius: 8,
          backgroundColor: result.success ? '#e6ffe6' : '#ffe6e6',
          display: 'inline-block',
        }}>
          {result.success ? (
            <>
              <div><strong>用户:</strong> {result.user_id}</div>
              <div><strong>眼别:</strong> {result.eye === 'L' ? '左眼' : '右眼'}</div>
              <div><strong>置信度:</strong> {result.confidence}%</div>
            </>
          ) : (
            <div style={{ color: 'red' }}>识别失败: {result.error}</div>
          )}
        </div>
      )}
    </div>
  );
};
```

### 5.4 使用示例

```tsx
// App.tsx
import React, { useState } from 'react';
import { IrisRegistration } from './components/IrisRegistration';
import { IrisRecognition } from './components/IrisRecognition';

function App() {
  const [mode, setMode] = useState<'register' | 'recognize'>('recognize');
  const [userId, setUserId] = useState('');

  return (
    <div style={{ padding: 24 }}>
      <div style={{ marginBottom: 24 }}>
        <button onClick={() => setMode('register')}>注册</button>
        <button onClick={() => setMode('recognize')} style={{ marginLeft: 8 }}>识别</button>
      </div>

      {mode === 'register' && (
        <div>
          <input
            placeholder="输入用户ID"
            value={userId}
            onChange={(e) => setUserId(e.target.value)}
            style={{ marginBottom: 16, padding: 8 }}
          />
          {userId && <IrisRegistration userId={userId} onComplete={(ok) => alert(ok ? '注册成功' : '注册失败')} />}
        </div>
      )}

      {mode === 'recognize' && (
        <IrisRecognition onRecognized={(r) => r.success && alert(`欢迎 ${r.user_id}`)} />
      )}
    </div>
  );
}

export default App;
```

---

## 六、部署指南

### 6.1 打包虹膜服务（免安装 Python）

```bash
# 安装 PyInstaller
pip install pyinstaller

# 打包（Linux）
pyinstaller --onefile \
    --add-data "util:util" \
    --hidden-import=cv2 \
    --hidden-import=numpy \
    --hidden-import=pywt \
    --name iris_service \
    iris_service.py

# 输出: dist/iris_service
```

### 6.2 部署目录结构

```
/opt/iris_service/
├── iris_service          # 可执行文件
├── photo/                # 虹膜图像
└── feature/              # 特征数据
```

### 6.3 Systemd 服务

```ini
# /etc/systemd/system/iris_service.service
[Unit]
Description=Iris Recognition Service
After=network.target

[Service]
Type=simple
WorkingDirectory=/opt/iris_service
ExecStart=/opt/iris_service/iris_service --host 0.0.0.0 --port 5000 --camera 0
Restart=always

[Install]
WantedBy=multi-user.target
```

```bash
sudo systemctl enable iris_service
sudo systemctl start iris_service
```

### 6.4 防火墙配置

```bash
# CentOS/RHEL
sudo firewall-cmd --add-port=5000/tcp --permanent
sudo firewall-cmd --reload

# Ubuntu
sudo ufw allow 5000
```

---

## 七、测试步骤

### 7.1 启动虹膜服务（Linux）

```bash
cd /opt/iris_service
./iris_service --host 0.0.0.0 --port 5000 --camera 0

# 或使用 Python 直接运行
python iris_service.py --host 0.0.0.0 --port 5000 --camera 0
```

### 7.2 验证服务

```bash
# 查看状态
curl http://192.168.1.100:5000/api/status

# 浏览器打开视频流
http://192.168.1.100:5000/api/video/stream
```

### 7.3 启动前端（本地）

```bash
# .env.development
REACT_APP_IRIS_URL=http://192.168.1.100:5000

npm start
```

---

## 八、注意事项

1. **摄像头索引**：通过 `ls /dev/video*` 查看，红外摄像头通常是 `/dev/video0`
2. **跨域已处理**：虹膜服务已配置 `CORS(app, origins="*")`
3. **视频流带检测框**：MJPEG 流自动绘制双圆（内圆=瞳孔，外圆=虹膜边界）
4. **采集数量**：左右眼各 5 张，可在代码中调整 `TARGET_PER_EYE`
5. **置信度阈值**：建议 > 50% 视为识别成功，可根据实际调整
